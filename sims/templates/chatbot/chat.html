{% extends 'base.html' %}
{% block title %}Chat{% endblock %}
{% block header %}
 
<style>
     #chat { border: 1px solid #ddd; padding: 1rem; height: 400px; overflow-y: auto; }
    .msg { margin: .5rem 0; }
    .user { text-align: right; color: #0a0; }
    .bot { text-align: left; color: #06f; }
    .disclaimer { background: #fffbe6; border: 1px solid #ffecb3; padding: .5rem; margin-bottom: 1rem; }
  </style>
 
{% endblock %}

{% block content %}

 
  <h1>Health Chat</h1>
  <div class="disclaimer">{{ disclaimer }}</div>
  <div id="chat" aria-live="polite"></div>

  <form id="chat-form">
    <input id="message" name="message" placeholder="Type your question..." style="width:80%;" autocomplete="off"/>
    <button type="submit">Send</button>
  </form>

  <script>
  const chatDiv = document.getElementById('chat');
  const form = document.getElementById('chat-form');
  const messageInput = document.getElementById('message');

  function appendMessage(text, cls) {
    const d = document.createElement('div');
    d.className = 'msg ' + cls;
    d.textContent = text;
    chatDiv.appendChild(d);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;
    appendMessage(text, 'user');
    messageInput.value = '';
    appendMessage('…', 'bot'); // placeholder
    try {
      const body = new URLSearchParams();
      body.append('message', text);

      const res = await fetch("{% url 'message_proxy' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Accept': 'application/json'
        },
        body
      });
      const data = await res.json();
      // remove last placeholder '…' message
      const last = chatDiv.querySelector('.msg.bot:last-child');
      if (last && last.textContent === '…') last.remove();

      if (!res.ok) {
        appendMessage("Error: " + (data.error || JSON.stringify(data)), 'bot');
      } else {
        appendMessage(data.reply, 'bot');
      }
    } catch (err) {
      appendMessage('Network error: ' + err.toString(), 'bot');
    }
  });

  // helper to get cookie
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  </script>

{% endblock %}

